{% extends "layout.html" %}
{% block contentBackground %}
{% if session['id'] %}
<div>
    <h2>{{ subjectCode }} {{ subjectName }}</h2>
</div>
<div>
    <script>
        function toggleGrouping() {
            var x = document.getElementById("groupingSection");
            var y = document.getElementById("groupingButtonImg");
            if (x.style.display === "none") {
                x.style.display = "block";
                y.src = "/static/img/up-arrow.png";
            } else {
                x.style.display = "none";
                y.src = "/static/img/down-arrow.png";
            }
        }

        function toggleArrow(button) {
            var arrowImg = button.querySelector('.arrow');
            arrowImg.classList.toggle('rotate');
        }

        document.addEventListener('DOMContentLoaded', function() {
            var studentButtons = document.querySelectorAll('.student');
            studentButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    toggleArrow(this);
                });
            });

            var adjustAvgButtons = document.querySelectorAll('.adjustAvg');
            adjustAvgButtons.forEach(function(button) {
                button.addEventListener('click', function(event) {
                    event.preventDefault(); // Prevent form submission
                    var studentId = this.getAttribute('data-student-id');
                    var avgRating = document.getElementById('avg' + studentId).textContent;
                    document.getElementById('lecturerRating' + studentId).value = avgRating;
                });
            });
        });
    </script>
    <h3 id="title">Student Group</h3>
    <div id="groupingHeader">
      <div id="groupingTitle">
          <button data-bs-toggle="collapse" type="button" data-bs-target="#groupingSection" class="student" style="background-color: transparent;display: flex;margin: 0; width: max-content;">
              <img src="/static/img/down-arrow.png" alt="arrow" id="groupingButtonImg" style="width: 20px; height: 20px;" class="arrow">
          </button>
          Grouping for {{ courseSection }}
      </div>
      <div id="exportGroupingbtn">
          <button value="exportAllGrouping">Export All</button>
      </div>
  </div>
    <div id="groupingSection" class="collapse">
        {% for group in studentGroups %}
        <div class="group">
            <button data-bs-toggle="collapse" type="button" data-bs-target="#group{{ group[0] }}" class="grouping student">
                <h4 style="margin-left: 0;">
                  <img src="/static/img/down-arrow.png" alt="arrow" style="width: 20px; height: 20px;" class="arrow">
                  Group {{ group[0] }}
                </h4>
            </button>
            <div id="group{{ group[0] }}" class="collapse">
                {% for student in group[1:] %}
                <div style="margin: 0px 10px;">
                    <button data-bs-toggle="collapse" type="button" data-bs-target="#student{{ student[0] }}" class="student">
                        <img src="/static/img/down-arrow.png" alt="arrow" style="width: 20px; height: 20px;" class="arrow">
                        {{ student[1] }}
                    </button>
                    <div id="student{{ student[0] }}" class="collapse studentReviews">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Student Name</th>
                                    <th>Ratings Given</th>
                                    {% if student[3][2] != 'Not reviewed by all students yet' %}
                                    <th>Average Rating</th>
                                    {% endif %}
                                    <th>Comment</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for i in range(1, group|length) %}
                                <tr>
                                    <td class="studentData">{{ group[i][0] }}</td>
                                    <td class="studentData">{{ group[i][1] }}</td>
                                    {% if student[3] is defined and student[3][i-1] is defined %}
                                    <td class="studentData">{{ student[3][i-1][1] }}</td>
                                    {% else %}
                                    <td class="studentData">None</td>
                                    {% endif %}
                                    {% if student[3][2] != 'Not reviewed by all students yet' %}
                                    <td class="studentData" id="avg{{group[i][0]}}">{{ group[i][2] }}</td>
                                    {% endif %}
                                    {% if student[3] is defined and student[3][i-1] is defined %}
                                    <td class="studentData" id="avg{{group[i][0]}}">{{ student[3][i-1][2] }}</td>
                                    {% else %}
                                    <td class="studentData">None</td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if student[4] is defined and student[4] is not none %}
                        <div class="lower-section">
                            <div class="lecturerForm">
                                    <form action="/lecturerRating" method="post" style="width: 100%;">
                                        <input type="hidden" name="studentId" value="{{ student[0] }}">
                                        <input type="hidden" name="courseId" value="{{ courseId }}">
                                        <input type="hidden" name="sectionId" value="{{ courseSection }}">
                                        <div style="padding:auto; display: flex;align-items: center;justify-content: center;padding: auto;">
                                            <label for="lecturerRating{{ student[0] }}" style="margin-right: 5px;">Lecturer Rating:</label>
                                            <input type="text" id="lecturerRating{{ student[0] }}" name="lecturerRating" style="width: max-content;display: inline;">
                                            <div style="align-items: center; padding: auto;margin-top: 35px; margin-left: 10px;">
                                                <button id="avgBtn" class="adjustAvg" data-student-id="{{ student[0] }}" style="margin: 5px auto; display: flex;">Match Average</button>
                                                <button id="submitBtn" type="submit" name="submitLectRating">Submit</button> 
                                            </div>
                                            
                                        </div>
                                        
                                    </form>
                            </div>
                            <div class="selfAssessment">
                                
                                    <h5>Self-assessment for {{ student[1] }}</h5>
                                    {% for i in range(1, student[4]|length+1) %}
                                    <div>
                                        <p>{{ student[4][i-1] }}</p>
                                    </div>
                                {% endfor %}
                               
                            </div>
                            
                        </div>
                        {% endif %} 
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}
